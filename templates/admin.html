<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Admin - PDF Controller</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        /* ê°€ë¡œëª¨ë“œ ê¶Œì¥ ë©”ì‹œì§€ */
        .rotate-message {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #667eea;
            color: white;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 9999;
            text-align: center;
            padding: 20px;
        }

        .rotate-message.show {
            display: flex;
        }

        .rotate-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: rotate 2s infinite;
        }

        @keyframes rotate {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(90deg); }
        }

        .rotate-message h2 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .rotate-message p {
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- ì„¸ë¡œëª¨ë“œ ê²½ê³  ë©”ì‹œì§€ -->
    <div class="rotate-message" id="rotateMessage">
        <div class="rotate-icon">ğŸ“±</div>
        <h2>í™”ë©´ì„ ê°€ë¡œë¡œ íšŒì „í•´ì£¼ì„¸ìš”</h2>
        <p>ë” ë‚˜ì€ PDF ì»¨íŠ¸ë¡¤ í™˜ê²½ì„ ìœ„í•´<br>ê°€ë¡œ ëª¨ë“œë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤</p>
    </div>
    <div class="container">
        <div class="admin-header">
            <h1>ê´€ë¦¬ì ì»¨íŠ¸ë¡¤ëŸ¬</h1>
            <a href="{{ url_for('upload') }}" class="btn btn-secondary">ë‹¤ë¥¸ PDF ì—…ë¡œë“œ</a>
        </div>

        {% if filename %}
        <div class="viewer-container">
            <div class="pdf-info">
                <span class="filename">{{ filename }}</span>
                <span class="page-info">
                    í˜ì´ì§€: <span id="currentPage">1</span> / <span id="totalPages">-</span>
                </span>
            </div>

            <div class="canvas-wrapper">
                <canvas id="pdfCanvas"></canvas>
            </div>

            <div class="controls">
                <button id="prevBtn" class="btn btn-control">â—€ ì´ì „</button>
                <div class="page-display">
                    <span id="pageNum">1</span> / <span id="pageCount">-</span>
                </div>
                <button id="nextBtn" class="btn btn-control">ë‹¤ìŒ â–¶</button>
            </div>
        </div>
        {% else %}
        <div class="no-pdf">
            <p>ì—…ë¡œë“œëœ PDFê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            <a href="{{ url_for('upload') }}" class="btn btn-primary">PDF ì—…ë¡œë“œí•˜ê¸°</a>
        </div>
        {% endif %}
    </div>

    <script>
        // PDF.js worker ì„¤ì •
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Socket.IO ì—°ê²°
        const socket = io();

        let pdfDoc = null;
        let currentPage = {{ page }};
        let totalPages = 0;
        const canvas = document.getElementById('pdfCanvas');
        const ctx = canvas.getContext('2d');

        // PDF ë¡œë“œ
        {% if filename %}
        const pdfUrl = "{{ url_for('static', filename='uploads/' + filename) }}";

        pdfjsLib.getDocument(pdfUrl).promise.then(function(pdf) {
            pdfDoc = pdf;
            totalPages = pdf.numPages;
            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('pageCount').textContent = totalPages;
            renderPage(currentPage);
        }).catch(function(error) {
            console.error('PDF ë¡œë“œ ì‹¤íŒ¨:', error);
            alert('PDF íŒŒì¼ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        });
        {% endif %}

        // í˜ì´ì§€ ë Œë”ë§
        function renderPage(num) {
            if (!pdfDoc) return;

            pdfDoc.getPage(num).then(function(page) {
                // ëª¨ë°”ì¼ ëŒ€ì‘: ìº”ë²„ìŠ¤ ë„ˆë¹„ë¥¼ í™”ë©´ì— ë§ì¶¤
                const container = document.querySelector('.canvas-wrapper');
                const containerWidth = container.clientWidth - 20; // padding ê³ ë ¤

                const viewport = page.getViewport({ scale: 1 });
                const scale = containerWidth / viewport.width;
                const scaledViewport = page.getViewport({ scale: scale });

                // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
                canvas.height = scaledViewport.height;
                canvas.width = scaledViewport.width;

                // CSS í¬ê¸°ë„ ë™ì¼í•˜ê²Œ ì„¤ì •
                canvas.style.width = scaledViewport.width + 'px';
                canvas.style.height = scaledViewport.height + 'px';

                const renderContext = {
                    canvasContext: ctx,
                    viewport: scaledViewport
                };

                page.render(renderContext);
            });

            // í˜ì´ì§€ ë²ˆí˜¸ ì—…ë°ì´íŠ¸
            document.getElementById('currentPage').textContent = num;
            document.getElementById('pageNum').textContent = num;
            currentPage = num;
        }

        // ì´ì „ í˜ì´ì§€
        document.getElementById('prevBtn').addEventListener('click', function() {
            if (currentPage <= 1) return;
            currentPage--;
            renderPage(currentPage);

            // ì„œë²„ë¡œ í˜ì´ì§€ ë³€ê²½ ì´ë²¤íŠ¸ ì „ì†¡
            socket.emit('admin_page_change', { page: currentPage });
        });

        // ë‹¤ìŒ í˜ì´ì§€
        document.getElementById('nextBtn').addEventListener('click', function() {
            if (currentPage >= totalPages) return;
            currentPage++;
            renderPage(currentPage);

            // ì„œë²„ë¡œ í˜ì´ì§€ ë³€ê²½ ì´ë²¤íŠ¸ ì „ì†¡
            socket.emit('admin_page_change', { page: currentPage });
        });

        // ë°˜ì‘í˜• ëŒ€ì‘: ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ì¬ë Œë”ë§
        let resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                if (pdfDoc) {
                    renderPage(currentPage);
                }
            }, 250);
        });

        // Socket ì´ë²¤íŠ¸
        socket.on('connect', function() {
            console.log('Socket connected');
        });

        socket.on('disconnect', function() {
            console.log('Socket disconnected');
        });

        // í™”ë©´ ë°©í–¥ ì œì–´ ë° ê°ì§€
        function checkOrientation() {
            const rotateMessage = document.getElementById('rotateMessage');

            // ëª¨ë°”ì¼ ê¸°ê¸°ì—ì„œë§Œ ì‘ë™
            if (window.innerWidth <= 767) {
                // ì„¸ë¡œ ëª¨ë“œì¸ ê²½ìš° ê²½ê³  í‘œì‹œ
                if (window.innerHeight > window.innerWidth) {
                    rotateMessage.classList.add('show');
                } else {
                    rotateMessage.classList.remove('show');
                }
            } else {
                rotateMessage.classList.remove('show');
            }
        }

        // ê°€ë¡œëª¨ë“œë¡œ ìë™ íšŒì „ ì‹œë„ (ì§€ì›ë˜ëŠ” ë¸Œë¼ìš°ì €ì—ì„œë§Œ)
        async function lockToLandscape() {
            try {
                // Screen Orientation API ì§€ì› í™•ì¸
                if (screen.orientation && screen.orientation.lock) {
                    await screen.orientation.lock('landscape');
                    console.log('í™”ë©´ì´ ê°€ë¡œëª¨ë“œë¡œ ê³ ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.log('ìë™ í™”ë©´ íšŒì „ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ íšŒì „í•´ì£¼ì„¸ìš”.');
                // ìë™ íšŒì „ì´ ì•ˆ ë˜ë©´ ë©”ì‹œì§€ë¡œ ìœ ë„
                checkOrientation();
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.addEventListener('load', function() {
            // ëª¨ë°”ì¼ ê¸°ê¸°ì¸ ê²½ìš° ê°€ë¡œëª¨ë“œ ì‹œë„
            if (window.innerWidth <= 767) {
                lockToLandscape();
            }
            checkOrientation();
        });

        // í™”ë©´ ë°©í–¥ ë³€ê²½ ê°ì§€
        window.addEventListener('orientationchange', checkOrientation);
        window.addEventListener('resize', checkOrientation);
    </script>
</body>
</html>
