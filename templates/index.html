<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>PDF Viewer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        /* ê°€ë¡œëª¨ë“œ ê¶Œì¥ ë©”ì‹œì§€ */
        .rotate-message {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #667eea;
            color: white;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 9999;
            text-align: center;
            padding: 20px;
        }

        .rotate-message.show {
            display: flex;
        }

        .rotate-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: rotate 2s infinite;
        }

        @keyframes rotate {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(90deg); }
        }

        .rotate-message h2 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .rotate-message p {
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- ì„¸ë¡œëª¨ë“œ ê²½ê³  ë©”ì‹œì§€ -->
    <div class="rotate-message" id="rotateMessage">
        <div class="rotate-icon">ğŸ“±</div>
        <h2>í™”ë©´ì„ ê°€ë¡œë¡œ íšŒì „í•´ì£¼ì„¸ìš”</h2>
        <p>ë” ë‚˜ì€ PDF ë³´ê¸° í™˜ê²½ì„ ìœ„í•´<br>ê°€ë¡œ ëª¨ë“œë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤</p>
    </div>
    <div class="container">
        <div class="viewer-header">
            <h1>ì‹¤ì‹œê°„ PDF ë·°ì–´</h1>
            <div class="connection-status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">ì—°ê²° ì¤‘...</span>
            </div>
        </div>

        <div id="contentArea">
            {% if filename %}
            <div class="viewer-container">
                <div class="pdf-info">
                    <span class="filename" id="pdfFilename">{{ filename }}</span>
                    <span class="page-info">
                        í˜ì´ì§€: <span id="currentPage">{{ page }}</span> / <span id="totalPages">-</span>
                    </span>
                </div>

                <div class="canvas-wrapper">
                    <canvas id="pdfCanvas"></canvas>
                </div>

                <div class="viewer-notice">
                    ê´€ë¦¬ìê°€ í˜ì´ì§€ë¥¼ ë³€ê²½í•˜ë©´ ìë™ìœ¼ë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤
                </div>
            </div>
            {% else %}
            <div class="no-pdf">
                <p>í˜„ì¬ ê³µìœ  ì¤‘ì¸ PDFê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                <p>ê´€ë¦¬ìê°€ PDFë¥¼ ì—…ë¡œë“œí•  ë•Œê¹Œì§€ ëŒ€ê¸°í•´ì£¼ì„¸ìš”.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        // PDF.js worker ì„¤ì •
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Socket.IO ì—°ê²°
        const socket = io();

        let pdfDoc = null;
        let currentPage = {{ page }};
        let totalPages = 0;
        const canvas = document.getElementById('pdfCanvas');
        const ctx = canvas ? canvas.getContext('2d') : null;
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        // PDF ë¡œë“œ í•¨ìˆ˜
        function loadPDF(filename, page) {
            if (!filename) {
                showNoPDF();
                return;
            }

            const pdfUrl = `/static/uploads/${filename}`;

            pdfjsLib.getDocument(pdfUrl).promise.then(function(pdf) {
                pdfDoc = pdf;
                totalPages = pdf.numPages;

                // í˜ì´ì§€ ì •ë³´ ì—…ë°ì´íŠ¸
                if (document.getElementById('totalPages')) {
                    document.getElementById('totalPages').textContent = totalPages;
                }

                renderPage(page);
            }).catch(function(error) {
                console.error('PDF ë¡œë“œ ì‹¤íŒ¨:', error);
                showError('PDF íŒŒì¼ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            });
        }

        // í˜ì´ì§€ ë Œë”ë§
        function renderPage(num) {
            if (!pdfDoc || !canvas || !ctx) return;

            pdfDoc.getPage(num).then(function(page) {
                // ëª¨ë°”ì¼ ëŒ€ì‘: ìº”ë²„ìŠ¤ ë„ˆë¹„ë¥¼ í™”ë©´ì— ë§ì¶¤
                const container = document.querySelector('.canvas-wrapper');
                const containerWidth = container.clientWidth - 20; // padding ê³ ë ¤

                const viewport = page.getViewport({ scale: 1 });
                const scale = containerWidth / viewport.width;
                const scaledViewport = page.getViewport({ scale: scale });

                // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
                canvas.height = scaledViewport.height;
                canvas.width = scaledViewport.width;

                // CSS í¬ê¸°ë„ ë™ì¼í•˜ê²Œ ì„¤ì •
                canvas.style.width = scaledViewport.width + 'px';
                canvas.style.height = scaledViewport.height + 'px';

                const renderContext = {
                    canvasContext: ctx,
                    viewport: scaledViewport
                };

                page.render(renderContext);
            });

            // í˜ì´ì§€ ë²ˆí˜¸ ì—…ë°ì´íŠ¸
            if (document.getElementById('currentPage')) {
                document.getElementById('currentPage').textContent = num;
            }
            currentPage = num;
        }

        // PDF ì—†ìŒ í™”ë©´ í‘œì‹œ
        function showNoPDF() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="no-pdf">
                    <p>í˜„ì¬ ê³µìœ  ì¤‘ì¸ PDFê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p>ê´€ë¦¬ìê°€ PDFë¥¼ ì—…ë¡œë“œí•  ë•Œê¹Œì§€ ëŒ€ê¸°í•´ì£¼ì„¸ìš”.</p>
                </div>
            `;
        }

        // ì—ëŸ¬ í‘œì‹œ
        function showError(message) {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="no-pdf error">
                    <p>${message}</p>
                </div>
            `;
        }

        // ìƒˆ PDF ë¡œë“œë¥¼ ìœ„í•œ HTML ì—…ë°ì´íŠ¸
        function updateViewerHTML(filename) {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="viewer-container">
                    <div class="pdf-info">
                        <span class="filename" id="pdfFilename">${filename}</span>
                        <span class="page-info">
                            í˜ì´ì§€: <span id="currentPage">1</span> / <span id="totalPages">-</span>
                        </span>
                    </div>

                    <div class="canvas-wrapper">
                        <canvas id="pdfCanvas"></canvas>
                    </div>

                    <div class="viewer-notice">
                        ê´€ë¦¬ìê°€ í˜ì´ì§€ë¥¼ ë³€ê²½í•˜ë©´ ìë™ìœ¼ë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤
                    </div>
                </div>
            `;
        }

        // Socket ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        socket.on('connect', function() {
            console.log('Socket connected');
            statusDot.className = 'status-dot connected';
            statusText.textContent = 'ì—°ê²°ë¨';
        });

        socket.on('disconnect', function() {
            console.log('Socket disconnected');
            statusDot.className = 'status-dot disconnected';
            statusText.textContent = 'ì—°ê²° ëŠê¹€';
        });

        // ì ‘ì† ì‹œ í˜„ì¬ ìƒíƒœ ìˆ˜ì‹ 
        socket.on('current_status', function(data) {
            console.log('Current status:', data);

            if (data.filename) {
                // í˜„ì¬ í‘œì‹œëœ íŒŒì¼ê³¼ ë‹¤ë¥¸ íŒŒì¼ì´ë©´ HTML ì—…ë°ì´íŠ¸
                const currentFilename = document.getElementById('pdfFilename');
                if (!currentFilename || currentFilename.textContent !== data.filename) {
                    updateViewerHTML(data.filename);
                }

                loadPDF(data.filename, data.page);
            } else {
                showNoPDF();
            }
        });

        // ê´€ë¦¬ìì˜ í˜ì´ì§€ ë³€ê²½ ìˆ˜ì‹ 
        socket.on('update_view', function(data) {
            console.log('Update view:', data);

            if (!data.filename) {
                showNoPDF();
                return;
            }

            // íŒŒì¼ì´ ë³€ê²½ëœ ê²½ìš°
            const currentFilename = document.getElementById('pdfFilename');
            if (!currentFilename || currentFilename.textContent !== data.filename) {
                updateViewerHTML(data.filename);
                loadPDF(data.filename, data.page);
            } else {
                // ê°™ì€ íŒŒì¼ì˜ í˜ì´ì§€ë§Œ ë³€ê²½ëœ ê²½ìš°
                renderPage(data.page);
            }
        });

        // ì´ˆê¸° PDF ë¡œë“œ (ì„œë²„ì—ì„œ ë Œë”ë§ëœ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°)
        {% if filename %}
        loadPDF('{{ filename }}', {{ page }});
        {% endif %}

        // ë°˜ì‘í˜• ëŒ€ì‘: ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ì¬ë Œë”ë§
        let resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                if (pdfDoc && canvas) {
                    renderPage(currentPage);
                }
            }, 250);
        });

        // í™”ë©´ ë°©í–¥ ì œì–´ ë° ê°ì§€
        function checkOrientation() {
            const rotateMessage = document.getElementById('rotateMessage');

            // ëª¨ë°”ì¼ ê¸°ê¸°ì—ì„œë§Œ ì‘ë™
            if (window.innerWidth <= 767) {
                // ì„¸ë¡œ ëª¨ë“œì¸ ê²½ìš° ê²½ê³  í‘œì‹œ
                if (window.innerHeight > window.innerWidth) {
                    rotateMessage.classList.add('show');
                } else {
                    rotateMessage.classList.remove('show');
                }
            } else {
                rotateMessage.classList.remove('show');
            }
        }

        // ê°€ë¡œëª¨ë“œë¡œ ìë™ íšŒì „ ì‹œë„ (ì§€ì›ë˜ëŠ” ë¸Œë¼ìš°ì €ì—ì„œë§Œ)
        async function lockToLandscape() {
            try {
                // Screen Orientation API ì§€ì› í™•ì¸
                if (screen.orientation && screen.orientation.lock) {
                    await screen.orientation.lock('landscape');
                    console.log('í™”ë©´ì´ ê°€ë¡œëª¨ë“œë¡œ ê³ ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.log('ìë™ í™”ë©´ íšŒì „ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ íšŒì „í•´ì£¼ì„¸ìš”.');
                // ìë™ íšŒì „ì´ ì•ˆ ë˜ë©´ ë©”ì‹œì§€ë¡œ ìœ ë„
                checkOrientation();
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.addEventListener('load', function() {
            // ëª¨ë°”ì¼ ê¸°ê¸°ì¸ ê²½ìš° ê°€ë¡œëª¨ë“œ ì‹œë„
            if (window.innerWidth <= 767) {
                lockToLandscape();
            }
            checkOrientation();
        });

        // í™”ë©´ ë°©í–¥ ë³€ê²½ ê°ì§€
        window.addEventListener('orientationchange', checkOrientation);
        window.addEventListener('resize', checkOrientation);
    </script>
</body>
</html>
