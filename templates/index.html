<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>PDF Viewer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        /* ê°€ë¡œëª¨ë“œ ê¶Œì¥ ë©”ì‹œì§€ */
        .rotate-message {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #667eea;
            color: white;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 9999;
            text-align: center;
            padding: 20px;
        }

        .rotate-message.show {
            display: flex;
        }

        .rotate-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: rotate 2s infinite;
        }

        @keyframes rotate {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(90deg); }
        }

        .rotate-message h2 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .rotate-message p {
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- ì„¸ë¡œëª¨ë“œ ê²½ê³  ë©”ì‹œì§€ -->
    <div class="rotate-message" id="rotateMessage">
        <div class="rotate-icon">ğŸ“±</div>
        <h2>í™”ë©´ì„ ê°€ë¡œë¡œ íšŒì „í•´ì£¼ì„¸ìš”</h2>
        <p>ë” ë‚˜ì€ PDF ë³´ê¸° í™˜ê²½ì„ ìœ„í•´<br>ê°€ë¡œ ëª¨ë“œë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤</p>
    </div>
    <div class="container">
        <div class="viewer-header">
            <div class="connection-status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">ì—°ê²° ì¤‘</span>
            </div>
        </div>

        <div id="contentArea">
            {% if filename %}
            <div class="viewer-container">
                <div class="canvas-wrapper">
                    <canvas id="pdfCanvas"></canvas>
                </div>

                <div class="controls">
                    <button id="prevBtn" class="btn btn-control">â—€</button>
                    <div class="page-display">
                        <span id="pageNum">{{ page }}</span> / <span id="maxPage">{{ page }}</span>
                    </div>
                    <button id="nextBtn" class="btn btn-control">â–¶</button>
                </div>
            </div>
            {% else %}
            <div class="no-pdf">
                <p>í˜„ì¬ ê³µìœ  ì¤‘ì¸ PDFê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                <p>ê´€ë¦¬ìê°€ PDFë¥¼ ì—…ë¡œë“œí•  ë•Œê¹Œì§€ ëŒ€ê¸°í•´ì£¼ì„¸ìš”.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        // PDF.js worker ì„¤ì •
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Socket.IO ì—°ê²°
        const socket = io();

        let pdfDoc = null;
        let currentPage = {{ page }};
        let maxAllowedPage = {{ page }}; // ê´€ë¦¬ìê°€ ì§„í–‰í•œ ìµœëŒ€ í˜ì´ì§€
        let totalPages = 0;
        let userViewingPage = {{ page }}; // ì‚¬ìš©ìê°€ í˜„ì¬ ë³´ê³  ìˆëŠ” í˜ì´ì§€
        let renderTask = null; // í˜„ì¬ ë Œë”ë§ ì‘ì—… ì¶”ì 
        const canvas = document.getElementById('pdfCanvas');
        const ctx = canvas ? canvas.getContext('2d') : null;
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        // PDF ë¡œë“œ í•¨ìˆ˜
        function loadPDF(filename, page) {
            console.log('loadPDF í˜¸ì¶œ:', filename, page);
            if (!filename) {
                showNoPDF();
                return;
            }

            const pdfUrl = `/static/uploads/${filename}`;
            console.log('PDF URL:', pdfUrl);

            pdfjsLib.getDocument(pdfUrl).promise.then(function(pdf) {
                console.log('PDF ë¡œë“œ ì„±ê³µ, ì´ í˜ì´ì§€:', pdf.numPages);
                pdfDoc = pdf;
                totalPages = pdf.numPages;

                renderPage(page);
            }).catch(function(error) {
                console.error('PDF ë¡œë“œ ì‹¤íŒ¨:', error);
                showError('PDF íŒŒì¼ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            });
        }

        // í˜ì´ì§€ ë Œë”ë§
        function renderPage(num) {
            console.log('renderPage í˜¸ì¶œ:', num);
            if (!pdfDoc || !canvas || !ctx) {
                console.log('ë Œë”ë§ ì¡°ê±´ ë¯¸ì¶©ì¡±');
                return;
            }

            // ì´ì „ ë Œë”ë§ ì‘ì—…ì´ ìˆìœ¼ë©´ ì·¨ì†Œ
            if (renderTask) {
                console.log('ì´ì „ ë Œë”ë§ ì·¨ì†Œ');
                renderTask.cancel();
            }

            pdfDoc.getPage(num).then(function(page) {
                const container = document.querySelector('.canvas-wrapper');
                if (!container) {
                    console.log('container ì—†ìŒ');
                    return;
                }

                // ëª¨ë°”ì¼ í™˜ê²½ ê°ì§€
                const isMobile = window.innerWidth <= 767;

                let scale;
                const viewport = page.getViewport({ scale: 1 });

                if (isMobile) {
                    // ëª¨ë°”ì¼: í™”ë©´ ë„ˆë¹„ì— ë§ì¶¤
                    const availableWidth = window.innerWidth - 20; // ì¢Œìš° íŒ¨ë”© 10pxì”©
                    scale = availableWidth / viewport.width;
                } else {
                    // ë°ìŠ¤í¬í†±: ì»¨í…Œì´ë„ˆì— ë§ì¶¤
                    const containerWidth = container.clientWidth - 40;
                    scale = containerWidth / viewport.width;
                }

                const scaledViewport = page.getViewport({ scale: scale });

                console.log('ìŠ¤ì¼€ì¼:', scale, 'ìº”ë²„ìŠ¤ í¬ê¸°:', scaledViewport.width, 'x', scaledViewport.height);

                // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
                canvas.height = scaledViewport.height;
                canvas.width = scaledViewport.width;

                // CSS í¬ê¸°ë„ ë™ì¼í•˜ê²Œ ì„¤ì •
                canvas.style.width = scaledViewport.width + 'px';
                canvas.style.height = scaledViewport.height + 'px';

                const renderContext = {
                    canvasContext: ctx,
                    viewport: scaledViewport
                };

                renderTask = page.render(renderContext);
                renderTask.promise.then(function() {
                    console.log('ë Œë”ë§ ì™„ë£Œ');
                    renderTask = null;
                }).catch(function(err) {
                    if (err.name === 'RenderingCancelledException') {
                        console.log('ë Œë”ë§ ì·¨ì†Œë¨');
                    } else {
                        console.error('ë Œë”ë§ ì˜¤ë¥˜:', err);
                    }
                    renderTask = null;
                });
            }).catch(function(error) {
                console.error('í˜ì´ì§€ ë¡œë“œ ì˜¤ë¥˜:', error);
            });

            // í˜ì´ì§€ ë²ˆí˜¸ ì—…ë°ì´íŠ¸
            if (document.getElementById('pageNum')) {
                document.getElementById('pageNum').textContent = num;
            }
            userViewingPage = num;
            updateNavigationButtons();
        }

        // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            if (prevBtn) {
                prevBtn.disabled = userViewingPage <= 1;
            }

            if (nextBtn) {
                nextBtn.disabled = userViewingPage >= maxAllowedPage;
            }
        }

        // PDF ì—†ìŒ í™”ë©´ í‘œì‹œ
        function showNoPDF() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="no-pdf">
                    <p>í˜„ì¬ ê³µìœ  ì¤‘ì¸ PDFê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p>ê´€ë¦¬ìê°€ PDFë¥¼ ì—…ë¡œë“œí•  ë•Œê¹Œì§€ ëŒ€ê¸°í•´ì£¼ì„¸ìš”.</p>
                </div>
            `;
        }

        // ì—ëŸ¬ í‘œì‹œ
        function showError(message) {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="no-pdf error">
                    <p>${message}</p>
                </div>
            `;
        }

        // ìƒˆ PDF ë¡œë“œë¥¼ ìœ„í•œ HTML ì—…ë°ì´íŠ¸
        function updateViewerHTML(filename) {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="viewer-container">
                    <div class="canvas-wrapper">
                        <canvas id="pdfCanvas"></canvas>
                    </div>

                    <div class="controls">
                        <button id="prevBtn" class="btn btn-control">â—€</button>
                        <div class="page-display">
                            <span id="pageNum">1</span> / <span id="maxPage">1</span>
                        </div>
                        <button id="nextBtn" class="btn btn-control">â–¶</button>
                    </div>
                </div>
            `;
            setupNavigationButtons();
        }

        // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ì„¤ì •
        function setupNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            if (prevBtn) {
                prevBtn.addEventListener('click', function() {
                    if (userViewingPage > 1) {
                        renderPage(userViewingPage - 1);
                    }
                });
            }

            if (nextBtn) {
                nextBtn.addEventListener('click', function() {
                    if (userViewingPage < maxAllowedPage) {
                        renderPage(userViewingPage + 1);
                    }
                });
            }
        }

        // Socket ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        socket.on('connect', function() {
            console.log('Socket connected');
            statusDot.className = 'status-dot connected';
            statusText.textContent = 'ì—°ê²°ë¨';
        });

        socket.on('disconnect', function() {
            console.log('Socket disconnected');
            statusDot.className = 'status-dot disconnected';
            statusText.textContent = 'ì—°ê²° ëŠê¹€';
        });

        // ì ‘ì† ì‹œ í˜„ì¬ ìƒíƒœ ìˆ˜ì‹ 
        socket.on('current_status', function(data) {
            console.log('Current status:', data);

            if (data.filename) {
                // ìµœëŒ€ í—ˆìš© í˜ì´ì§€ ì„¤ì •
                maxAllowedPage = data.page;
                currentPage = data.page;

                // maxPage í‘œì‹œ ì—…ë°ì´íŠ¸
                const maxPageElement = document.getElementById('maxPage');
                if (maxPageElement) {
                    maxPageElement.textContent = maxAllowedPage;
                }

                loadPDF(data.filename, data.page);
            } else {
                showNoPDF();
            }
        });

        // ê´€ë¦¬ìì˜ í˜ì´ì§€ ë³€ê²½ ìˆ˜ì‹ 
        socket.on('update_view', function(data) {
            console.log('Update view:', data);

            if (!data.filename) {
                showNoPDF();
                return;
            }

            // ìµœëŒ€ í—ˆìš© í˜ì´ì§€ ì—…ë°ì´íŠ¸ (ê´€ë¦¬ìê°€ ì§„í–‰í•œ í˜ì´ì§€ê¹Œì§€)
            if (data.page > maxAllowedPage) {
                maxAllowedPage = data.page;
            }
            currentPage = data.page;

            // maxPage í‘œì‹œ ì—…ë°ì´íŠ¸
            const maxPageElement = document.getElementById('maxPage');
            if (maxPageElement) {
                maxPageElement.textContent = maxAllowedPage;
            }

            // íŒŒì¼ì´ ë³€ê²½ëœ ê²½ìš°
            if (!pdfDoc) {
                updateViewerHTML(data.filename);
                loadPDF(data.filename, data.page);
            } else {
                // ê°™ì€ íŒŒì¼ì˜ í˜ì´ì§€ë§Œ ë³€ê²½ëœ ê²½ìš°
                // ê´€ë¦¬ì í˜ì´ì§€ë¥¼ ìë™ìœ¼ë¡œ ë”°ë¼ê°
                renderPage(data.page);
            }
        });

        // ì´ˆê¸° PDF ë¡œë“œ (ì„œë²„ì—ì„œ ë Œë”ë§ëœ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°)
        {% if filename %}
        loadPDF('{{ filename }}', {{ page }});
        setupNavigationButtons();
        {% endif %}

        // ë°˜ì‘í˜• ëŒ€ì‘: ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ì¬ë Œë”ë§
        let resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                if (pdfDoc && canvas) {
                    renderPage(userViewingPage);
                }
            }, 250);
        });

        // í™”ë©´ ë°©í–¥ ì œì–´ ë° ê°ì§€
        function checkOrientation() {
            const rotateMessage = document.getElementById('rotateMessage');

            // ëª¨ë°”ì¼ ê¸°ê¸°ì—ì„œë§Œ ì‘ë™
            if (window.innerWidth <= 767) {
                // ì„¸ë¡œ ëª¨ë“œì¸ ê²½ìš° ê²½ê³  í‘œì‹œ
                if (window.innerHeight > window.innerWidth) {
                    rotateMessage.classList.add('show');
                } else {
                    rotateMessage.classList.remove('show');
                }
            } else {
                rotateMessage.classList.remove('show');
            }
        }

        // ê°€ë¡œëª¨ë“œë¡œ ìë™ íšŒì „ ì‹œë„ (ì§€ì›ë˜ëŠ” ë¸Œë¼ìš°ì €ì—ì„œë§Œ)
        async function lockToLandscape() {
            try {
                // Screen Orientation API ì§€ì› í™•ì¸
                if (screen.orientation && screen.orientation.lock) {
                    await screen.orientation.lock('landscape');
                    console.log('í™”ë©´ì´ ê°€ë¡œëª¨ë“œë¡œ ê³ ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.log('ìë™ í™”ë©´ íšŒì „ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ íšŒì „í•´ì£¼ì„¸ìš”.');
                // ìë™ íšŒì „ì´ ì•ˆ ë˜ë©´ ë©”ì‹œì§€ë¡œ ìœ ë„
                checkOrientation();
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.addEventListener('load', function() {
            // ëª¨ë°”ì¼ ê¸°ê¸°ì¸ ê²½ìš° ê°€ë¡œëª¨ë“œ ì‹œë„
            if (window.innerWidth <= 767) {
                lockToLandscape();
            }
            checkOrientation();
        });

        // í™”ë©´ ë°©í–¥ ë³€ê²½ ê°ì§€
        window.addEventListener('orientationchange', checkOrientation);
        window.addEventListener('resize', checkOrientation);
    </script>
</body>
</html>
